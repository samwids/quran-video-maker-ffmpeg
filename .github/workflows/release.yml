name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag, e.g. v1.0.0"
        required: true
      prerelease:
        description: "Is this a prerelease?"
        type: boolean
        default: false
      build_linux:
        description: 'Build and upload Linux artifacts'
        type: boolean
        default: true
      build_macos:
        description: 'Build and upload macOS artifacts'
        type: boolean
        default: true
      build_windows:
        description: 'Build and upload Windows artifacts'
        type: boolean
        default: true

env:
  BUILD_DIR: build
  BUILD_TYPE: Release

jobs:
  build-linux:
    if: ${{ inputs.build_linux }}
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download data.tar
      run: curl -L https://qvm-r2-storage.tawbah.app/data.tar -o data.tar

    - name: Install build deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libavformat-dev libavcodec-dev libavfilter-dev \
          libavutil-dev libswscale-dev \
          libfreetype6-dev libharfbuzz-dev \
          libcurl4-openssl-dev libssl-dev zlib1g-dev
        sudo apt-get install -y ffmpeg

    - name: Cache vcpkg
      id: cache-vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ~/vcpkg
          ~/.cache/vcpkg
        key: vcpkg-linux-x64-aws-sdk-v2

    - name: Setup vcpkg
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
        ~/vcpkg/bootstrap-vcpkg.sh -disableMetrics

    - name: Install AWS SDK via vcpkg
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      run: |
        ~/vcpkg/vcpkg install aws-sdk-cpp[s3]:x64-linux

    - name: Set vcpkg environment
      run: |
        echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
        echo "CMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV

    - name: Extract data.tar
      run: tar -xf data.tar

    - name: Configure CMake
      run: |
        VERSION="${{ github.event.inputs.version }}"
        VER_NO_V="${VERSION#v}"
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCPACK_PACKAGE_VERSION="$VER_NO_V" \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DFETCHCONTENT_QUIET=OFF \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Package with CPack
      run: |
        cd $BUILD_DIR
        cpack -G ZIP

    - name: Upload Linux package
      uses: actions/upload-artifact@v4
      with:
        name: qvm-linux-release
        path: build/qvm-*.zip

  build-macos:
    if: ${{ inputs.build_macos }}
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download data.tar
      run: curl -L https://qvm-r2-storage.tawbah.app/data.tar -o data.tar

    - name: Extract data.tar
      run: tar -xf data.tar

    - name: Install dependencies via Homebrew
      run: |
        brew update
        brew install ffmpeg freetype harfbuzz pkg-config aws-sdk-cpp

    - name: Export pkgconfig paths (macOS)
      run: |
        echo "PKG_CONFIG_PATH=/opt/homebrew/opt/ffmpeg/lib/pkgconfig:/opt/homebrew/lib/pkgconfig:/usr/local/opt/ffmpeg/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        VERSION="${{ github.event.inputs.version }}"
        VER_NO_V="${VERSION#v}"
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCPACK_PACKAGE_VERSION="$VER_NO_V" \
          -DCMAKE_PREFIX_PATH="$(brew --prefix)" \
          -DFETCHCONTENT_QUIET=OFF \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Package with CPack
      run: |
        cd $BUILD_DIR
        cpack -G ZIP

    - name: Upload macOS package
      uses: actions/upload-artifact@v4
      with:
        name: qvm-macos-release
        path: build/qvm-*.zip

  build-windows:
    if: ${{ inputs.build_windows }}
    runs-on: windows-latest

    steps:
    - name: Enable long paths
      run: |
        git config --system core.longpaths true

    - uses: actions/checkout@v4

    - name: Set up MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        msystem: UCRT64
        install: >-
          ucrt64/mingw-w64-ucrt-x86_64-gcc
          ucrt64/mingw-w64-ucrt-x86_64-pkgconf
          ucrt64/mingw-w64-ucrt-x86_64-cmake
          ucrt64/mingw-w64-ucrt-x86_64-ninja
          ucrt64/mingw-w64-ucrt-x86_64-curl
          ucrt64/mingw-w64-ucrt-x86_64-cpr
          ucrt64/mingw-w64-ucrt-x86_64-nlohmann-json
          ucrt64/mingw-w64-ucrt-x86_64-cxxopts
          ucrt64/mingw-w64-ucrt-x86_64-ffmpeg
          ucrt64/mingw-w64-ucrt-x86_64-freetype
          ucrt64/mingw-w64-ucrt-x86_64-harfbuzz
          ucrt64/mingw-w64-ucrt-x86_64-aws-sdk-cpp

    - name: Download data.tar
      shell: msys2 {0}
      run: curl -L -o data.tar https://qvm-r2-storage.tawbah.app/data.tar

    - name: Extract data.tar
      shell: msys2 {0}
      run: tar -xf data.tar

    - name: Configure CMake
      shell: msys2 {0}
      run: |
        VERSION="${{ github.event.inputs.version }}"
        VER_NO_V="${VERSION#v}"
        export PKG_CONFIG_PATH="/ucrt64/lib/pkgconfig:/ucrt64/share/pkgconfig:$PKG_CONFIG_PATH"
        cmake -B build -G "Ninja" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCPACK_PACKAGE_VERSION="$VER_NO_V" \
          -S $GITHUB_WORKSPACE

    - name: Build
      shell: msys2 {0}
      run: cmake --build build --config Release

    - name: Download CA bundle for curl
      shell: msys2 {0}
      run: |
        mkdir -p build
        curl -L -o build/ca-bundle.crt https://curl.se/ca/cacert.pem

    - name: Copy all runtime dependencies
      shell: msys2 {0}
      run: |
        cd build
        mkdir -p deps
        ldd qvm.exe | grep ucrt64 | awk '{print $3}' | xargs -I {} cp {} deps/
            
    - name: Package with CPack
      shell: msys2 {0}
      run: |
        cd build
        cpack -G ZIP

    - name: Upload Windows packages
      uses: actions/upload-artifact@v4
      with:
        name: qvm-windows-release
        path: build/qvm-*.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download Linux artifacts
      if: ${{ inputs.build_linux }}
      uses: actions/download-artifact@v4
      with:
        name: qvm-linux-release
        path: artifacts/linux

    - name: Download macOS artifacts
      if: ${{ inputs.build_macos }}
      uses: actions/download-artifact@v4
      with:
        name: qvm-macos-release
        path: artifacts/macos

    - name: Download Windows artifacts
      if: ${{ inputs.build_windows }}
      uses: actions/download-artifact@v4
      with:
        name: qvm-windows-release
        path: artifacts/windows

    - name: Compute Windows artifact SHA
      if: ${{ inputs.build_windows }}
      id: winsha
      run: |
        WIN_ZIP=$(find artifacts/windows -name "qvm-*-win64.zip" | head -n1)
        if [ -n "$WIN_ZIP" ]; then
          echo "win_sha=$(shasum -a 256 "$WIN_ZIP" | awk '{print $1}')" >> $GITHUB_OUTPUT
        fi

    - name: Generate Scoop manifest
      if: ${{ inputs.build_windows }}
      run: |
        VERSION="${{ github.event.inputs.version }}"
        VER_NO_V="${VERSION#v}"
        WIN_ZIP=$(find artifacts/windows -name "qvm-*-win64.zip" -printf "%f\n" | head -n1)
        cp scoop/qvm.json scoop-qvm.json
        sed -i.bak \
          -e "s/0.0.0/${VER_NO_V}/" \
          -e "s|qvm-0.0.0-dev-win64.zip|${WIN_ZIP}|" \
          -e "s/REPLACE_WITH_SHA256_OF_qvm-bin-windows.zip/${{ steps.winsha.outputs.win_sha }}/" \
          scoop-qvm.json
        rm scoop-qvm.json.bak

    - name: Prepare source tarball
      run: |
        mkdir release-src
        git archive --format=tar --prefix=qvm-${{ github.event.inputs.version }}/ HEAD | tar -xf - -C release-src
        tar -czf qvm-${{ github.event.inputs.version }}.tar.gz -C release-src qvm-${{ github.event.inputs.version }}

    - name: Collect release files
      id: collect
      run: |
        FILES="qvm-${{ github.event.inputs.version }}.tar.gz"
        if [ -d artifacts/linux ]; then
          FILES="$FILES $(find artifacts/linux -type f)"
        fi
        if [ -d artifacts/macos ]; then
          FILES="$FILES $(find artifacts/macos -type f)"
        fi
        if [ -d artifacts/windows ]; then
          FILES="$FILES $(find artifacts/windows -type f)"
        fi
        if [ -f scoop-qvm.json ]; then
          FILES="$FILES scoop-qvm.json"
        fi
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$FILES" | tr ' ' '\n' >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Publish GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        files: ${{ steps.collect.outputs.files }}
        prerelease: ${{ github.event.inputs.prerelease }}
