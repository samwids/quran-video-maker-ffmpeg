name: CMake (Linux + macOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: build
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download test data
      run: curl -L https://qvm-r2-storage.tawbah.app/data.tar -o data.tar

    - name: Install build deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libavformat-dev libavcodec-dev libavfilter-dev \
          libavutil-dev libswscale-dev \
          libfreetype6-dev libharfbuzz-dev
        sudo apt-get install -y ffmpeg

    - name: Configure CMake
      run: |
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DFETCHCONTENT_QUIET=OFF \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Extract test data
      run: tar -xf data.tar

    - name: Test
      run: |
        cd "$BUILD_DIR"
        ctest --build-config "$BUILD_TYPE" --rerun-failed --output-on-failure
        cd ..
        mkdir -p out
        ./build/qvm 1 1 7 --reciter 2 --translation 1 --quality-profile speed --width 640 --height 360 --output out/ci-smoke.mp4
        test -s out/ci-smoke.mp4
        test -s out/thumbnail.jpeg

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download test data
      run: curl -L https://qvm-r2-storage.tawbah.app/data.tar -o data.tar

    - name: Install FFmpeg dependencies
      run: |
        brew update
        brew install ffmpeg freetype harfbuzz

    - name: Export FFmpeg pkgconfig paths (macOS)
      run: |
        export PKG_CONFIG_PATH="/opt/homebrew/opt/ffmpeg/lib/pkgconfig:/usr/local/opt/ffmpeg/lib/pkgconfig:$PKG_CONFIG_PATH"
        echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DFETCHCONTENT_QUIET=OFF \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Extract test data
      run: tar -xf data.tar

    - name: Test
      run: |
        cd "$BUILD_DIR"
        ctest --build-config "$BUILD_TYPE" --rerun-failed --output-on-failure
        cd ..
        mkdir -p out
        ./build/qvm 1 1 7 --reciter 2 --translation 1 --quality-profile speed --width 640 --height 360 --output out/ci-smoke.mp4
        test -s out/ci-smoke.mp4
        test -s out/thumbnail.jpeg
