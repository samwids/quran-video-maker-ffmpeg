name: CMake (Linux + macOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: build
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    - name: Install build deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libavformat-dev libavcodec-dev libavfilter-dev \
          libavutil-dev libswscale-dev \
          libfreetype6-dev libharfbuzz-dev

    - name: Cache CMake build and dependencies
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt', 'src/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-

    - name: Configure CMake
      run: |
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DFETCHCONTENT_QUIET=OFF \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Extract test data
      run: tar -xf data.tar

    - name: Test
      run: |
        cd "$BUILD_DIR"
        ctest --build-config "$BUILD_TYPE" --rerun-failed --output-on-failure

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    - name: Install FFmpeg dependencies
      run: |
        brew update
        brew install ffmpeg freetype harfbuzz

    - name: Cache CMake build and dependencies
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt', 'src/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-

    - name: Export FFmpeg pkgconfig paths (macOS)
      run: |
        export PKG_CONFIG_PATH="/opt/homebrew/opt/ffmpeg/lib/pkgconfig:/usr/local/opt/ffmpeg/lib/pkgconfig:$PKG_CONFIG_PATH"
        echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B $BUILD_DIR \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DFETCHCONTENT_QUIET=OFF \
          -S ${{ github.workspace }}

    - name: Build
      run: cmake --build $BUILD_DIR --config $BUILD_TYPE

    - name: Extract test data
      run: tar -xf data.tar

    - name: Test
      run: |
        cd "$BUILD_DIR"
        ctest --build-config "$BUILD_TYPE" --rerun-failed --output-on-failure